name: Build Executables

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

  # Trigger on new tags (for releases)
  push:
    tags:
      - 'v*'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r build_requirements.txt

      - name: Build Windows executable
        run: |
          pyinstaller --clean --noconfirm ancestree.spec

      - name: Upload Windows executable
        uses: actions/upload-artifact@v4
        with:
          name: Ancestree-Windows
          path: dist/Ancestree.exe
          if-no-files-found: error

      - name: Create release asset (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Ancestree.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS Executable
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r build_requirements.txt

      - name: Build macOS application
        run: |
          pyinstaller --clean --noconfirm ancestree.spec

      - name: Create DMG (optional)
        run: |
          # Create a simple DMG for distribution
          mkdir -p dmg
          cp -R dist/Ancestree.app dmg/
          ln -s /Applications dmg/Applications
          hdiutil create -volname "Ancestree" -srcfolder dmg -ov -format UDZO Ancestree.dmg

      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: Ancestree-macOS-App
          path: dist/Ancestree.app
          if-no-files-found: error

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: Ancestree-macOS-DMG
          path: Ancestree.dmg
          if-no-files-found: error

      - name: Create release assets (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Ancestree.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux Executable
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r build_requirements.txt

      - name: Build Linux executable
        run: |
          pyinstaller --clean --noconfirm ancestree.spec

      - name: Create AppImage
        run: |
          # Download AppImage tools
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy executable
          cp -r dist/Ancestree AppDir/usr/bin/

          # Create .desktop file
          cat > AppDir/ancestree.desktop << 'EOF'
          [Desktop Entry]
          Name=Ancestree
          Exec=Ancestree
          Icon=ancestree
          Type=Application
          Categories=Utility;
          Comment=Build and explore your family tree
          EOF

          # Copy desktop file to required location
          cp AppDir/ancestree.desktop AppDir/usr/share/applications/

          # Create AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH}"
          exec "${HERE}/usr/bin/Ancestree" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Create icon (placeholder - use default)
          touch AppDir/ancestree.png
          cp AppDir/ancestree.png AppDir/usr/share/icons/hicolor/256x256/apps/

          # Build AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir Ancestree-x86_64.AppImage
          chmod +x Ancestree-x86_64.AppImage

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Ancestree-Linux
          path: Ancestree-x86_64.AppImage
          if-no-files-found: error

      - name: Create release asset (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: Ancestree-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-notes:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create release notes
        uses: softprops/action-gh-release@v1
        with:
          body: |
            # Ancestree Release ${{ github.ref_name }}

            ## ðŸ“¦ Installation

            ### Windows
            1. Download `Ancestree.exe`
            2. Run the installer script: `scripts\install_windows.bat` (as Administrator)
            3. Double-click `Ancestree.exe` to launch

            ### macOS
            1. Download `Ancestree.dmg`
            2. Run the installer script: `./scripts/install_macos.sh`
            3. Open the DMG and drag Ancestree to Applications
            4. Right-click Ancestree.app â†’ Open (first time only)

            ### Linux
            1. Download `Ancestree-x86_64.AppImage`
            2. Run the installer script: `./scripts/install_linux.sh`
            3. Make it executable: `chmod +x Ancestree-x86_64.AppImage`
            4. Run: `./Ancestree-x86_64.AppImage`

            ## âš ï¸ Important

            **Docker Desktop is required!** Use the automated installers in the `scripts/` directory:
            - Windows: `scripts\install_windows.bat`
            - macOS: `./scripts/install_macos.sh`
            - Linux: `./scripts/install_linux.sh`

            ## ðŸ“š Documentation

            - **Users**: See `docs/FOR_USERS.md`
            - **Developers**: See `docs/FOR_DEVELOPERS.md`
            - **Installation**: See `docs/INSTALLATION_GUIDE.md`

            ## ðŸ› Issues?

            Report issues at: https://github.com/${{ github.repository }}/issues
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
